<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Travel Checklist</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>
    
    <script>
        const { useState, useEffect, createElement: h } = React;

        // Telegram WebApp integration helper functions
        function setTelegramColors() {
            if (!window.Telegram || !window.Telegram.WebApp) return;
            const WebApp = window.Telegram.WebApp;

            const tgTheme = WebApp.themeParams || {};
            const bgColor = tgTheme.bg_color || "#0f172a";
            const textColor = tgTheme.text_color || "#e5e7eb";
            const hintColor = tgTheme.hint_color || "#94a3b8";
            const btnColor = tgTheme.button_color || "#22c55e";
            const btnTextColor = tgTheme.button_text_color || "#ffffff";

            WebApp.setHeaderColor(bgColor);
            WebApp.setBottomBarColor(bgColor);
            WebApp.setBackgroundColor(bgColor);
            WebApp.setHeaderColor(bgColor);

            document.documentElement.style.setProperty("--bg-color", bgColor);
            document.documentElement.style.setProperty("--text-color", textColor);
            document.documentElement.style.setProperty("--hint-color", hintColor);
            document.documentElement.style.setProperty("--btn-color", btnColor);
            document.documentElement.style.setProperty("--btn-text-color", btnTextColor);

            document.body.style.backgroundColor = bgColor;
            document.body.style.color = textColor;
        }

        function readyTelegram() {
            if (!window.Telegram || !window.Telegram.WebApp) return;
            const WebApp = window.Telegram.WebApp;
            try { WebApp.ready(); } catch (_) {}
            try { WebApp.expand(); } catch (_) {}
        }

        // Sostituisce lucide con una semplice mappa di “icone” (emoji) per evitare l’errore React #130
        const ICON = {Plus:'➕', Trash2:'🗑️', GripVertical:'⋮⋮', RotateCcw:'↺', Plane:'✈️', Edit2:'✏️', Check:'✓', X:'✕'};

        // Dati iniziali
        const DEFAULT_GROUPS = [
            {
                id: "docs",
                name: "Documenti",
                items: [
                    { id: "passport", label: "Passaporto / Carta d'identità" },
                    { id: "tickets", label: "Biglietti / Boarding pass" },
                    { id: "insurance", label: "Assicurazione viaggio" }
                ]
            },
            {
                id: "tech",
                name: "Tecnologia",
                items: [
                    { id: "phone", label: "Telefono" },
                    { id: "charger", label: "Caricabatterie" },
                    { id: "powerbank", label: "Power bank" }
                ]
            },
            {
                id: "toiletries",
                name: "Toeletta",
                items: [
                    { id: "toothbrush", label: "Spazzolino" },
                    { id: "toothpaste", label: "Dentifricio" },
                    { id: "deodorant", label: "Deodorante" }
                ]
            }
        ];

        function loadState() {
            try {
                const raw = localStorage.getItem("travel-checklist-state");
                return raw ? JSON.parse(raw) : null;
            } catch {
                return null;
            }
        }

        function saveState(state) {
            try {
                localStorage.setItem("travel-checklist-state", JSON.stringify(state));
            } catch {}
        }

        function TravelChecklistApp() {
            const [groups, setGroups] = useState(() => {
                const saved = loadState();
                return saved?.groups || DEFAULT_GROUPS;
            });
            const [checks, setChecks] = useState(() => {
                const saved = loadState();
                return saved?.checks || {};
            });
            const [title, setTitle] = useState(() => {
                const saved = loadState();
                return saved?.title || "Checklist Viaggio";
            });
            const [newItemLabel, setNewItemLabel] = useState("");
            const [selectedGroup, setSelectedGroup] = useState(groups[0]?.id || "docs");

            useEffect(() => {
                setTelegramColors();
                readyTelegram();
            }, []);

            useEffect(() => {
                saveState({ groups, checks, title });
            }, [groups, checks, title]);

            function toggleCheck(id) {
                setChecks(prev => ({ ...prev, [id]: !prev[id] }));
            }

            function addItem() {
                const trimmed = newItemLabel.trim();
                if (!trimmed) return;
                setGroups(prev => prev.map(g => g.id === selectedGroup ? {
                    ...g,
                    items: [...g.items, { id: `${g.id}-${Date.now()}`, label: trimmed }]
                } : g));
                setNewItemLabel("");
            }

            function removeItem(groupId, itemId) {
                setGroups(prev => prev.map(g => g.id === groupId ? {
                    ...g,
                    items: g.items.filter(i => i.id !== itemId)
                } : g));
                setChecks(prev => {
                    const cp = { ...prev };
                    delete cp[itemId];
                    return cp;
                });
            }

            function handleResetChecks() {
                setChecks({});
            }

            function handleResetAll() {
                if (!confirm("Sicuro di voler ripristinare i dati iniziali?")) return;
                setGroups(DEFAULT_GROUPS);
                setChecks({});
                setTitle("Checklist Viaggio");
            }

            function handleTitleChange(e) {
                setTitle(e.target.value);
            }

            function GroupCard({ group }) {
                const done = group.items.filter(i => checks[i.id]).length;
                const total = group.items.length;
                const allDone = total > 0 && done === total;

                return h(
                    'div',
                    { className: 'rounded-2xl p-4 shadow-lg bg-slate-800/60 border border-slate-700' },
                    h('div', { className: 'flex items-center justify-between mb-2' },
                        h('div', { className: 'flex items-center gap-2' },
                            h('span', { className: 'text-2xl' }, ICON.GripVertical),
                            h('h3', { className: 'text-lg font-semibold' }, group.name)
                        ),
                        h('span', { className: 'text-sm opacity-70' }, `${done}/${total}`)
                    ),

                    // Items
                    ...group.items.map(item => h('label', {
                        key: item.id,
                        className: 'flex items-center justify-between gap-3 py-2'
                    },
                        h('div', { className: 'flex items-center gap-3' },
                            h('input', {
                                type: 'checkbox',
                                checked: !!checks[item.id],
                                onChange: () => toggleCheck(item.id),
                                className: 'size-5 rounded border-slate-600 accent-emerald-500'
                            }),
                            h('span', { className: checks[item.id] ? 'line-through opacity-60' : '' }, item.label)
                        ),
                        h('button', {
                            onClick: () => removeItem(group.id, item.id),
                            className: 'text-sm opacity-70 hover:opacity-100 active:scale-95 transition'
                        }, ICON.Trash2)
                    )),

                    // Add item input per questo gruppo (visibile solo se selezionato)
                    selectedGroup === group.id && h('div', { className: 'mt-3 flex items-center gap-2' },
                        h('input', {
                            type: 'text',
                            placeholder: 'Aggiungi elemento…',
                            value: newItemLabel,
                            onChange: e => setNewItemLabel(e.target.value),
                            onKeyDown: e => e.key === 'Enter' ? addItem() : null,
                            className: 'flex-1 rounded-xl bg-slate-900 px-3 py-2 border border-slate-700 outline-none focus:ring-2 ring-emerald-500'
                        }),
                        h('button', {
                            onClick: addItem,
                            className: 'px-3 py-2 rounded-xl bg-emerald-600 hover:bg-emerald-500 active:scale-95 transition shadow'
                        }, h('span', { className: 'text-xl' }, ICON.Plus))
                    )
                );
            }

            return h(
                'div',
                { className: 'min-h-screen p-4 sm:p-6 md:p-8 text-slate-100' },
                h('div', { className: 'max-w-3xl mx-auto' },
                    // Header
                    h('header', { className: 'text-center mb-6' },
                        h('div', { className: 'mx-auto w-min text-5xl mb-3 opacity-60' }, ICON.Plane),
                        h('input', {
                            value: title,
                            onChange: handleTitleChange,
                            className: 'bg-transparent text-2xl sm:text-3xl font-semibold text-center outline-none border-b border-transparent focus:border-slate-600',
                        })
                    ),

                    // Controls
                    h('div', { className: 'flex flex-col sm:flex-row gap-2 sm:gap-3 mb-4' },
                        h('select', {
                            value: selectedGroup,
                            onChange: e => setSelectedGroup(e.target.value),
                            className: 'flex-1 rounded-xl bg-slate-900 px-3 py-2 border border-slate-700 outline-none focus:ring-2 ring-emerald-500'
                        },
                            groups.map(g => h('option', { key: g.id, value: g.id }, g.name))
                        ),
                        h('button', {
                            onClick: handleResetChecks,
                            className: 'px-3 py-2 rounded-xl bg-orange-500 hover:bg-orange-400 active:scale-95 transition shadow flex items-center justify-center gap-2'
                        }, h('span', null, ICON.RotateCcw), 'Reset selezioni'),
                        h('button', {
                            onClick: handleResetAll,
                            className: 'px-3 py-2 rounded-xl bg-red-600 hover:bg-red-500 active:scale-95 transition shadow flex items-center justify-center gap-2'
                        }, h('span', null, ICON.X), 'Ripristina tutto')
                    ),

                    // Groups grid
                    h('div', { className: 'grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4' },
                        groups.map(g => h(GroupCard, { key: g.id, group: g }))
                    ),

                    // Bottom CTA
                    h('button', {
                        onClick: handleResetChecks,
                        className: 'w-full mt-4 bg-orange-500 hover:bg-orange-400 text-white font-medium rounded-2xl px-4 py-3 flex items-center justify-center gap-2 transition-all active:scale-95 shadow-lg'
                    },
                        ICON.RotateCcw,
                        'Reset Selezioni per Nuovo Viaggio'
                    )
                )
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(h(TravelChecklistApp));
    </script>
</body>
</html>
